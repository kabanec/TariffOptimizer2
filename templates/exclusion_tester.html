<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exclusion Stacking Tester - Tariff Optimizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .exclusion-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        .exclusion-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .exclusion-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .duty-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison-column {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }
        .comparison-column h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        .duty-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #059bd2;
        }
        .duty-item.excluded {
            opacity: 0.5;
            text-decoration: line-through;
            border-left-color: #dc3545;
        }
        .duty-item.reduced {
            border-left-color: #ffc107;
        }
        .total-row {
            font-size: 1.2em;
            font-weight: bold;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-top: 15px;
        }
        .info-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .badge-exempt {
            background: #dc3545;
            color: white;
        }
        .badge-reduced {
            background: #ffc107;
            color: #333;
        }
        .exclusion-details {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .logic-display {
            margin-top: 8px;
            padding: 8px;
            background: #e8f4f8;
            border-left: 3px solid #059bd2;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .reference-link {
            margin-top: 8px;
            font-size: 0.85em;
        }
        .reference-link a {
            color: #059bd2;
            text-decoration: none;
        }
        .reference-link a:hover {
            text-decoration: underline;
        }
        .update-checker-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }
        .btn-check-updates {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-check-updates:hover {
            background: #e0a800;
        }
        .updates-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        .updates-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            max-width: 900px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .update-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border-left: 4px solid #059bd2;
        }
        .update-item.type-new {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .update-item.type-revoked {
            border-left-color: #dc3545;
            background: #fef2f2;
        }
        .update-item.type-extended {
            border-left-color: #667eea;
            background: #f0f4ff;
        }
        .update-item.type-modified, .update-item.type-policy_change, .update-item.type-policy-change {
            border-left-color: #ffc107;
            background: #fffbeb;
        }
        .update-item.type-superseded, .update-item.type-expired {
            border-left-color: #e74c3c;
            background: #fef5f5;
        }
        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        .close-modal:hover {
            color: #333;
        }
        .update-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 10px;
        }
        .badge-new { background: #10b981; color: white; }
        .badge-revoked { background: #dc3545; color: white; }
        .badge-superseded { background: #e74c3c; color: white; }
        .badge-expired { background: #e67e22; color: white; }
        .badge-extended { background: #667eea; color: white; }
        .badge-modified, .badge-policy_change, .badge-policy-change { background: #ffc107; color: #333; }
        .badge-analysis { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Exclusion Stacking Tester</h1>
            <p>Test Section 99 tariff exclusions and stacking logic</p>
            <div style="text-align: right; margin-top: 10px;">
                <span style="color: white; margin-right: 15px;">Welcome, {{ username }}!</span>
                <a href="{{ url_for('index') }}" style="color: white; text-decoration: underline; margin-right: 15px;">‚Üê Home</a>
                <a href="{{ url_for('logout') }}" style="color: white; text-decoration: underline;">Logout</a>
            </div>
        </header>

        <main>
            <div class="update-checker-section">
                <strong>üîî Database Validation & Updates:</strong> Automatically checks for Executive Orders, Presidential Proclamations, and Federal Register notices that may have REVOKED, SUPERSEDED, or MODIFIED existing exclusions.
                <br><small style="color: #856404; margin-top: 5px; display: block;">‚ö†Ô∏è IMPORTANT: Exclusions may be revoked by newer EOs/rules. Always validate against current regulations before relying on any exclusion.</small>
                <button id="checkUpdatesBtn" class="btn-check-updates" style="margin-left: 0px; margin-top: 10px;">
                    Check for Updates & Validate Exclusions
                </button>
                <span id="lastCheckedDisplay" style="margin-left: 15px; font-size: 0.9em; color: #666;"></span>
            </div>

            <div class="card">
                <h2>Product Information</h2>
                <p style="color: #666; font-size: 0.95em; margin-bottom: 20px;">
                    <strong>Research Sources:</strong> CBP Section 232 FAQs, USTR Section 301 guidance, Federal Register notices, USMCA provisions.
                    Last updated: December 2025. Note: All General Approved Exclusions (GAEs) and country-level arrangements were revoked effective March 12, 2025.
                </p>
                <form id="exclusionForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="hsCode">HS Code *</label>
                            <input type="text" id="hsCode" class="form-control" placeholder="e.g., 3305.10.00.00" required>
                        </div>
                        <div class="form-group">
                            <label for="shipmentValue">Shipment Value (USD) *</label>
                            <input type="number" id="shipmentValue" class="form-control" value="100" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="originCountry">Origin Country *</label>
                            <select id="originCountry" class="form-control" required>
                                <option value="">-- Select Country --</option>
                                <option value="CN" selected>China (CN)</option>
                                <option value="CA">Canada (CA)</option>
                                <option value="MX">Mexico (MX)</option>
                                <option value="DE">Germany (DE)</option>
                                <option value="JP">Japan (JP)</option>
                                <option value="KR">South Korea (KR)</option>
                                <option value="GB">United Kingdom (GB)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="destinationCountry">Destination Country *</label>
                            <select id="destinationCountry" class="form-control" required>
                                <option value="">-- Select Country --</option>
                                <option value="US" selected>United States (US)</option>
                                <option value="CA">Canada (CA)</option>
                                <option value="MX">Mexico (MX)</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-icon">üîç</span>
                            Analyze Exclusions
                        </button>
                    </div>
                </form>
            </div>

            <div id="resultsSection" style="display: none;">
                <div class="card">
                    <h2>Potential Exclusion Codes</h2>
                    <p style="margin-bottom: 20px;">Select applicable exclusions to see how they affect your duties:</p>
                    <div id="exclusionsList"></div>
                </div>

                <div class="card">
                    <h2>Duty Comparison</h2>
                    <div class="duty-comparison">
                        <div class="comparison-column">
                            <h3>Before Exclusions</h3>
                            <div id="dutiesBefore"></div>
                            <div class="total-row">
                                Total Duties: $<span id="totalBefore">0.00</span>
                            </div>
                        </div>
                        <div class="comparison-column">
                            <h3>After Exclusions</h3>
                            <div id="dutiesAfter"></div>
                            <div class="total-row">
                                Total Duties: $<span id="totalAfter">0.00</span>
                                <br>
                                <span style="font-size: 0.85em;">Savings: $<span id="savings">0.00</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Avalara Inc.</p>
        </footer>
    </div>

    <!-- Updates Modal -->
    <div id="updatesModal" class="updates-modal">
        <div class="updates-modal-content">
            <span class="close-modal" onclick="closeUpdatesModal()">&times;</span>
            <h2>Recent Exclusion Database Updates</h2>
            <p id="updatesModalSubtitle" style="color: #666; margin-bottom: 20px;"></p>
            <div id="updatesContent"></div>
        </div>
    </div>

    <script>
        // Exclusion database - researched from official CBP regulations and Federal Register
        // Sources: CBP.gov Section 232 FAQs, USTR Section 301 guidance, Federal Register notices
        const EXCLUSIONS_DATABASE = {
            // Section 232 Steel - UPDATED WITH RESEARCH
            'section_232_steel': [
                {
                    code: '9903.01.26',
                    name: 'USMCA Exemption: Canada Origin',
                    description: 'Goods that originate in Canada under USMCA qualify for exemption from Section 232 steel duties. Note: All General Approved Exclusions (GAEs) were revoked effective March 12, 2025.',
                    appliesToHsCodes: ['99038187', '99038188', '99038189', '99038190', '99038191', '99038193'],
                    effect: 'EXEMPT',
                    conditions: {
                        originCountries: ['CA'],
                        requiresUSMCA: true
                    },
                    source: 'USMCA general note 11 to HTSUS; CBP CSMS guidance',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/232-tariffs-aluminum-and-steel-faqs',
                    logicDescription: 'IF origin_country == "CA" AND qualifies_for_USMCA THEN exempt from Section 232 steel duties'
                },
                {
                    code: '9903.01.27',
                    name: 'USMCA Exemption: Mexico Origin',
                    description: 'Goods that originate in Mexico under USMCA qualify for exemption from Section 232 steel duties. Note: All General Approved Exclusions (GAEs) were revoked effective March 12, 2025.',
                    appliesToHsCodes: ['99038187', '99038188', '99038189', '99038190', '99038191', '99038193'],
                    effect: 'EXEMPT',
                    conditions: {
                        originCountries: ['MX'],
                        requiresUSMCA: true
                    },
                    source: 'USMCA general note 11 to HTSUS; CBP CSMS guidance',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/232-tariffs-aluminum-and-steel-faqs',
                    logicDescription: 'IF origin_country == "MX" AND qualifies_for_USMCA THEN exempt from Section 232 steel duties'
                },
                {
                    code: '9903.81.92',
                    name: 'U.S.-Origin Steel Exemption',
                    description: 'Derivative steel articles made exclusively from steel melted and poured in the United States (0% tariff-rate). Does NOT apply if steel scrap is remelted and poured outside the U.S.',
                    appliesToHsCodes: ['99038189', '99038190', '99038191', '99038193'],
                    effect: 'EXEMPT',
                    conditions: {
                        usOrigin: true,
                        meltedAndPouredInUS: true
                    },
                    source: 'CBP Section 232 FAQs; Presidential Proclamation',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/232-tariffs-aluminum-and-steel-faqs',
                    logicDescription: 'IF steel_melted_in_US == true AND steel_poured_in_US == true AND NOT (steel_scrap_remelted_outside_US) THEN apply 0% tariff-rate (exempt)'
                },
                {
                    code: 'PRODUCT_EXCLUSION',
                    name: 'Commerce Product-Specific Exclusion',
                    description: 'Time-limited product exclusion granted by U.S. Department of Commerce (valid 1 year or until quantity exhausted). NOTE: Commerce is no longer processing new exclusion requests as of Feb 10, 2025.',
                    appliesToHsCodes: ['99038187', '99038188', '99038189', '99038190', '99038191', '99038193'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresExclusionApproval: true,
                        requiresIORMatch: true,
                        quantityLimited: true
                    },
                    source: 'CBP Active Section 232 Product Exclusions list (updated weekly)',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/section-232-exclusions',
                    logicDescription: 'IF has_approved_exclusion == true AND importer_of_record_matches == true AND quantity_not_exceeded == true THEN exempt (valid until expiration_date OR quantity_exhausted)'
                }
            ],
            // Section 232 Aluminum - UPDATED WITH RESEARCH
            'section_232_aluminum': [
                {
                    code: '9903.01.26',
                    name: 'USMCA Exemption: Canada Origin',
                    description: 'Goods that originate in Canada under USMCA qualify for exemption from Section 232 aluminum duties. Note: All General Approved Exclusions (GAEs) were revoked effective March 12, 2025.',
                    appliesToHsCodes: ['99038502', '99038504', '99038507', '99038508', '99038509'],
                    effect: 'EXEMPT',
                    conditions: {
                        originCountries: ['CA'],
                        requiresUSMCA: true
                    },
                    source: 'USMCA general note 11 to HTSUS; CBP CSMS guidance',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/232-tariffs-aluminum-and-steel-faqs',
                    logicDescription: 'IF origin_country == "CA" AND qualifies_for_USMCA THEN exempt from Section 232 aluminum duties'
                },
                {
                    code: '9903.01.27',
                    name: 'USMCA Exemption: Mexico Origin',
                    description: 'Goods that originate in Mexico under USMCA qualify for exemption from Section 232 aluminum duties. Note: All General Approved Exclusions (GAEs) were revoked effective March 12, 2025.',
                    appliesToHsCodes: ['99038502', '99038504', '99038507', '99038508', '99038509'],
                    effect: 'EXEMPT',
                    conditions: {
                        originCountries: ['MX'],
                        requiresUSMCA: true
                    },
                    source: 'USMCA general note 11 to HTSUS; CBP CSMS guidance',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/232-tariffs-aluminum-and-steel-faqs',
                    logicDescription: 'IF origin_country == "MX" AND qualifies_for_USMCA THEN exempt from Section 232 aluminum duties'
                },
                {
                    code: 'US_ORIGIN_ALUMINUM',
                    name: 'U.S.-Origin Aluminum Exemption',
                    description: 'Derivative aluminum articles made exclusively from aluminum smelted and cast in the United States qualify for exemption from Section 232 duties.',
                    appliesToHsCodes: ['99038504', '99038507', '99038508', '99038509'],
                    effect: 'EXEMPT',
                    conditions: {
                        usOrigin: true,
                        smeltedAndCastInUS: true
                    },
                    source: 'CBP Section 232 FAQs; Presidential Proclamation',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/232-tariffs-aluminum-and-steel-faqs',
                    logicDescription: 'IF aluminum_smelted_in_US == true AND aluminum_cast_in_US == true THEN exempt from Section 232 aluminum duties'
                },
                {
                    code: 'PRODUCT_EXCLUSION_AL',
                    name: 'Commerce Product-Specific Exclusion',
                    description: 'Time-limited product exclusion granted by U.S. Department of Commerce (valid 1 year or until quantity exhausted). NOTE: Commerce is no longer processing new exclusion requests as of Feb 10, 2025.',
                    appliesToHsCodes: ['99038502', '99038504', '99038507', '99038508', '99038509'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresExclusionApproval: true,
                        requiresIORMatch: true,
                        quantityLimited: true
                    },
                    source: 'CBP Active Section 232 Product Exclusions list (updated weekly)',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/section-232-exclusions',
                    logicDescription: 'IF has_approved_exclusion == true AND importer_of_record_matches == true AND quantity_not_exceeded == true THEN exempt (valid until expiration_date OR quantity_exhausted)'
                }
            ],
            // Section 301 China tariffs - UPDATED WITH RESEARCH
            'section_301': [
                {
                    code: '9903.88.69',
                    name: 'USTR Product-Specific Exclusion (164 products)',
                    description: '164 product-specific exclusions covering certain industrial equipment, EVs, batteries, critical minerals, semiconductors and solar cells. Extended through November 10, 2026.',
                    appliesToHsCodes: ['99038803', '99038804', '99038809', '99038815'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresProductMatch: true,
                        mustMatchDetailedDescription: true
                    },
                    source: 'USTR Federal Register Notice; U.S. note 20(vvv) to subchapter III of chapter 99',
                    reference: 'https://www.federalregister.gov/documents/2025/09/02/2025-16733/notice-of-product-exclusion-extensions-chinas-acts-policies-and-practices-related-to-technology',
                    logicDescription: 'IF product_description_matches_USTR_list == true AND origin_country == "CN" THEN exempt from Section 301 duties (valid through Nov 10, 2026)'
                },
                {
                    code: '9903.88.70',
                    name: 'USTR Manufacturing Equipment Exclusion (14 products)',
                    description: '14 exclusions for manufacturing equipment related to solar manufacturing and other technologies. Extended through November 10, 2026.',
                    appliesToHsCodes: ['99038803', '99038804', '99038809', '99038815'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresProductMatch: true,
                        mustMatchDetailedDescription: true,
                        manufacturingEquipment: true
                    },
                    source: 'USTR Federal Register Notice; U.S. note 20(www) to subchapter III of chapter 99',
                    reference: 'https://www.federalregister.gov/documents/2025/09/02/2025-16733/notice-of-product-exclusion-extensions-chinas-acts-policies-and-practices-related-to-technology',
                    logicDescription: 'IF product_description_matches_USTR_manufacturing_equipment_list == true AND origin_country == "CN" THEN exempt from Section 301 duties (valid through Nov 10, 2026)'
                },
                {
                    code: 'SECTION_321',
                    name: 'De Minimis Exemption (Section 321)',
                    description: 'Products properly entered under Section 321 (de minimis shipments) are not subject to Section 301 duties. Note: Goods with quota restrictions require formal entry.',
                    appliesToHsCodes: ['99038803', '99038804', '99038809', '99038815'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresSection321Entry: true,
                        noQuotaRestrictions: true
                    },
                    source: 'CBP Section 301 Trade Remedies FAQs',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/section-301-trade-remedies/faqs',
                    logicDescription: 'IF entry_type == "Section_321" AND shipment_value <= de_minimis_threshold AND NOT (has_quota_restrictions) THEN exempt from Section 301 duties'
                },
                {
                    code: 'CHAPTER_98',
                    name: 'Chapter 98 Provisions',
                    description: 'Duties do not apply to entries properly claimed under Chapter 98 provisions (except 9802.00.40, 9802.00.50, 9802.00.60, 9802.00.80 where duties apply to specific value components).',
                    appliesToHsCodes: ['99038803', '99038804', '99038809', '99038815'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresChapter98Entry: true,
                        excludesCertainSubheadings: true
                    },
                    source: 'CBP Section 301 Trade Remedies FAQs',
                    reference: 'https://www.cbp.gov/trade/programs-administration/entry-summary/section-301-trade-remedies/faqs',
                    logicDescription: 'IF properly_entered_under_chapter_98 == true AND NOT (subheading IN ["9802.00.40", "9802.00.50", "9802.00.60", "9802.00.80"]) THEN exempt from Section 301 duties'
                }
            ],
            // IEEPA Reciprocal Tariffs and Fentanyl-Related
            'ieepa_reciprocal': [
                {
                    code: '9903.01.21',
                    name: 'Informational Materials Exemption',
                    description: 'Informational materials including publications, films, posters, phonograph records, photographs, microfilms, microfiche, tapes, compact discs, CD ROMs, artworks, and news wire feeds are exempt from IEEPA tariffs.',
                    appliesToHsCodes: ['99030124', '99030120', '99030122'],
                    baseHsCodes: ['3305.10.00.00', '4901.*', '4902.*', '8523.*', '9701.*'],
                    effect: 'EXEMPT',
                    conditions: {
                        isInformationalMaterial: true
                    },
                    source: 'CBP IEEPA FAQs; CSMS #66749380',
                    reference: 'https://www.cbp.gov/trade/programs-administration/trade-remedies/IEEPA-FAQ',
                    logicDescription: 'IF product_type IN [publications, films, posters, phonograph_records, photographs, microfilms, microfiche, tapes, CDs, CD_ROMs, artworks, news_wire_feeds] THEN exempt from IEEPA tariffs'
                },
                {
                    code: '9903.01.30',
                    name: 'China/Hong Kong/Macau IEEPA Reciprocal Exclusion',
                    description: 'Goods with country of origin China, Hong Kong, or Macau may be eligible for IEEPA Reciprocal exclusions. Currently 10% reciprocal tariff applies if not excluded.',
                    appliesToHsCodes: ['99030125', '99030120'],
                    baseHsCodes: ['3305.10.00.00', '*'],
                    effect: 'REDUCED',
                    conditions: {
                        originCountries: ['CN', 'HK', 'MO'],
                        requiresQualification: true
                    },
                    source: 'CBP CSMS #64649265; IEEPA FAQs',
                    reference: 'https://content.govdelivery.com/accounts/USDHSCBP/bulletins/3da7831',
                    logicDescription: 'IF origin_country IN ["CN", "HK", "MO"] AND qualifies_for_exclusion THEN reduced IEEPA reciprocal tariff (10% instead of higher rate)'
                },
                {
                    code: '9903.01.33',
                    name: 'Section 232 Exemption from Reciprocal Tariffs',
                    description: 'Products subject to Section 232 Steel, Aluminum, Autos tariffs are exempt from IEEPA Reciprocal tariffs. The steel/aluminum/copper content line can claim this exception.',
                    appliesToHsCodes: ['99030124', '99030120'],
                    baseHsCodes: ['7208.*', '7606.*', '8703.*'],
                    effect: 'EXEMPT',
                    conditions: {
                        subjectToSection232: true
                    },
                    source: 'CBP IEEPA FAQs; CSMS guidance on reciprocal tariffs',
                    reference: 'https://www.cbp.gov/trade/programs-administration/trade-remedies/IEEPA-FAQ',
                    logicDescription: 'IF subject_to_section_232_tariffs == true (steel/aluminum/autos/copper content) THEN exempt from IEEPA reciprocal tariffs under 9903.01.33'
                },
                {
                    code: '9903.01.34',
                    name: 'U.S. Content Exemption (>20%)',
                    description: 'Goods containing greater than 20% of U.S. content are exempt from IEEPA reciprocal tariffs.',
                    appliesToHsCodes: ['99030125', '99030120', '99030124'],
                    baseHsCodes: ['3305.10.00.00', '*'],
                    effect: 'EXEMPT',
                    conditions: {
                        usContentPercentage: { min: 20 }
                    },
                    source: 'CBP CSMS #64649265; IEEPA FAQs',
                    reference: 'https://content.govdelivery.com/accounts/USDHSCBP/bulletins/3da7831',
                    logicDescription: 'IF us_content_percentage > 20% THEN exempt from IEEPA reciprocal tariffs'
                }
            ]
        };

        // Sample duties for testing (normally would come from API)
        let currentDuties = [];
        let selectedExclusions = new Set();

        // Load exclusions database from localStorage if available (with updated exclusions from AI)
        function loadExclusionsDatabase() {
            const stored = localStorage.getItem('exclusionsDatabase');
            if (stored) {
                try {
                    const parsedDB = JSON.parse(stored);
                    // Merge stored exclusions with hardcoded ones (hardcoded takes precedence)
                    for (const category in parsedDB) {
                        if (!EXCLUSIONS_DATABASE[category]) {
                            EXCLUSIONS_DATABASE[category] = parsedDB[category];
                        }
                    }
                    console.log('Loaded exclusions database from localStorage');
                } catch (e) {
                    console.error('Failed to load exclusions database from localStorage:', e);
                }
            }
        }

        // Save exclusions database to localStorage
        function saveExclusionsDatabase() {
            try {
                localStorage.setItem('exclusionsDatabase', JSON.stringify(EXCLUSIONS_DATABASE));
                localStorage.setItem('exclusionsDatabaseUpdated', new Date().toISOString());
                console.log('Saved exclusions database to localStorage');
            } catch (e) {
                console.error('Failed to save exclusions database to localStorage:', e);
            }
        }

        // Load database on startup
        loadExclusionsDatabase();

        document.getElementById('exclusionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            analyzeTariffs();
        });

        function analyzeTariffs() {
            const hsCode = document.getElementById('hsCode').value;
            const value = parseFloat(document.getElementById('shipmentValue').value);
            const origin = document.getElementById('originCountry').value;
            const destination = document.getElementById('destinationCountry').value;

            // Mock duties based on HS code and origin
            // In production, this would come from AvaTax API
            currentDuties = generateMockDuties(hsCode, origin, value);

            displayExclusions(origin);
            displayDutyComparison();
            document.getElementById('resultsSection').style.display = 'block';
        }

        function generateMockDuties(hsCode, origin, value) {
            const duties = [];

            // For HS 3305* from China, add Section 232, Section 301, and IEEPA duties
            if (hsCode.startsWith('3305') && origin === 'CN') {
                duties.push({
                    code: '99038187',
                    name: 'SECTION 232 STEEL AND STEEL DERIVATIVES',
                    rate: 0.25,
                    amount: value * 0.25,
                    category: 'section_232_steel'
                });
                duties.push({
                    code: '99038502',
                    name: 'SECTION 232 ALUMINUM AND ALUMINUM DERIVATIVES',
                    rate: 0.10,
                    amount: value * 0.10,
                    category: 'section_232_aluminum'
                });
                duties.push({
                    code: '99038803',
                    name: 'SECTION 301 - CHINA',
                    rate: 0.25,
                    amount: value * 0.25,
                    category: 'section_301'
                });
                duties.push({
                    code: '99030125',
                    name: 'IEEPA RECIPROCAL TARIFF - CHINA',
                    rate: 0.10,
                    amount: value * 0.10,
                    category: 'ieepa_reciprocal'
                });
                duties.push({
                    code: '99030122',
                    name: 'IEEPA FENTANYL TARIFF - CHINA',
                    rate: 0.20,
                    amount: value * 0.20,
                    category: 'ieepa_reciprocal'
                });
            }

            return duties;
        }

        function displayExclusions(origin) {
            const exclusionsList = document.getElementById('exclusionsList');
            exclusionsList.innerHTML = '';
            selectedExclusions.clear();

            // Find all applicable exclusions
            const applicableExclusions = [];

            for (const category in EXCLUSIONS_DATABASE) {
                EXCLUSIONS_DATABASE[category].forEach(exclusion => {
                    // Check if any current duty matches this exclusion
                    const matchingDuty = currentDuties.find(duty =>
                        exclusion.appliesToHsCodes.includes(duty.code)
                    );

                    if (matchingDuty && checkExclusionConditions(exclusion, origin)) {
                        applicableExclusions.push({
                            ...exclusion,
                            dutyCode: matchingDuty.code,
                            dutyName: matchingDuty.name
                        });
                    }
                });
            }

            if (applicableExclusions.length === 0) {
                exclusionsList.innerHTML = '<p style="color: #666; font-style: italic;">No exclusions available for this product and origin combination.</p>';
                return;
            }

            applicableExclusions.forEach(exclusion => {
                const card = document.createElement('div');
                card.className = 'exclusion-card';

                // Build conditions display
                let conditionsHTML = '<div class="exclusion-details"><strong>Conditions:</strong><br>';
                for (const [key, value] of Object.entries(exclusion.conditions)) {
                    conditionsHTML += `‚Ä¢ ${key}: ${Array.isArray(value) ? value.join(', ') : JSON.stringify(value)}<br>`;
                }
                conditionsHTML += '</div>';

                // Build logic display
                const logicHTML = exclusion.logicDescription ?
                    `<div class="logic-display"><strong>Logic:</strong> ${exclusion.logicDescription}</div>` : '';

                // Build base HS codes display
                const baseHsCodesHTML = exclusion.baseHsCodes ?
                    `<div style="margin-top: 8px; font-size: 0.85em; color: #059bd2;"><strong>Base HS Codes:</strong> ${exclusion.baseHsCodes.join(', ')}</div>` : '';

                // Build reference link
                const referenceHTML = exclusion.reference ?
                    `<div class="reference-link">üìÑ <a href="${exclusion.reference}" target="_blank">Official Reference</a> | Source: ${exclusion.source}</div>` :
                    `<div class="reference-link">Source: ${exclusion.source}</div>`;

                card.innerHTML = `
                    <label style="cursor: pointer; display: block;">
                        <input type="checkbox" class="exclusion-checkbox" data-code="${exclusion.code}" data-duty="${exclusion.dutyCode}" data-effect="${exclusion.effect}">
                        <strong>${exclusion.name}</strong>
                        <span class="info-badge badge-${exclusion.effect.toLowerCase()}">${exclusion.effect}</span>
                        <br>
                        <small style="color: #666;">Exclusion Code: ${exclusion.code} | Applies to Chapter 99: ${exclusion.dutyName}</small>
                        ${baseHsCodesHTML}
                        <br>
                        <small>${exclusion.description}</small>
                    </label>
                    ${conditionsHTML}
                    ${logicHTML}
                    ${referenceHTML}
                `;
                exclusionsList.appendChild(card);

                card.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedExclusions.add(exclusion.code);
                        card.classList.add('selected');
                    } else {
                        selectedExclusions.delete(exclusion.code);
                        card.classList.remove('selected');
                    }
                    displayDutyComparison();
                });
            });
        }

        function checkExclusionConditions(exclusion, origin) {
            if (exclusion.conditions.originCountries) {
                return exclusion.conditions.originCountries.includes(origin);
            }
            // Add more condition checks as needed
            return true;
        }

        function displayDutyComparison() {
            const dutiesBefore = document.getElementById('dutiesBefore');
            const dutiesAfter = document.getElementById('dutiesAfter');

            dutiesBefore.innerHTML = '';
            dutiesAfter.innerHTML = '';

            let totalBefore = 0;
            let totalAfter = 0;

            currentDuties.forEach(duty => {
                totalBefore += duty.amount;

                // Before exclusions
                const beforeItem = document.createElement('div');
                beforeItem.className = 'duty-item';
                beforeItem.innerHTML = `
                    <strong>${duty.name}</strong><br>
                    Rate: ${(duty.rate * 100).toFixed(2)}%<br>
                    Amount: $${duty.amount.toFixed(2)}
                `;
                dutiesBefore.appendChild(beforeItem);

                // After exclusions
                const afterItem = document.createElement('div');
                afterItem.className = 'duty-item';

                // Check if this duty is excluded
                const isExcluded = isExclusionApplied(duty.code);

                if (isExcluded) {
                    afterItem.classList.add('excluded');
                    afterItem.innerHTML = `
                        <strong>${duty.name}</strong><br>
                        <span style="color: #dc3545;">EXCLUDED</span><br>
                        Original: $${duty.amount.toFixed(2)} ‚Üí $0.00
                    `;
                } else {
                    totalAfter += duty.amount;
                    afterItem.innerHTML = `
                        <strong>${duty.name}</strong><br>
                        Rate: ${(duty.rate * 100).toFixed(2)}%<br>
                        Amount: $${duty.amount.toFixed(2)}
                    `;
                }
                dutiesAfter.appendChild(afterItem);
            });

            document.getElementById('totalBefore').textContent = totalBefore.toFixed(2);
            document.getElementById('totalAfter').textContent = totalAfter.toFixed(2);
            document.getElementById('savings').textContent = (totalBefore - totalAfter).toFixed(2);
        }

        function isExclusionApplied(dutyCode) {
            // Check if any selected exclusion applies to this duty
            for (const category in EXCLUSIONS_DATABASE) {
                for (const exclusion of EXCLUSIONS_DATABASE[category]) {
                    if (selectedExclusions.has(exclusion.code) &&
                        exclusion.appliesToHsCodes.includes(dutyCode)) {
                        return true;
                    }
                }
            }
            return false;
        }

        // ========== UPDATE CHECKER FUNCTIONALITY ==========

        // Check for exclusion updates
        document.getElementById('checkUpdatesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('checkUpdatesBtn');
            btn.disabled = true;
            btn.textContent = 'Checking for updates...';

            try {
                // Get last check date from localStorage (or default to 90 days ago)
                const lastCheck = localStorage.getItem('lastExclusionCheck') ||
                    new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                const response = await fetch('/api/check-exclusion-updates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lastCheckDate: lastCheck })
                });

                const data = await response.json();

                if (data.success) {
                    // Store the check timestamp
                    localStorage.setItem('lastExclusionCheck', new Date().toISOString().split('T')[0]);
                    displayUpdatesModal(data);
                } else {
                    alert('Error checking for updates: ' + data.error);
                }
            } catch (error) {
                console.error('Error checking updates:', error);
                alert('Failed to check for updates: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Check for Updates';
            }
        });

        // Display updates modal
        function displayUpdatesModal(data) {
            const modal = document.getElementById('updatesModal');
            const subtitle = document.getElementById('updatesModalSubtitle');
            const content = document.getElementById('updatesContent');

            subtitle.textContent = `Found ${data.updatesFound} update(s). Last checked: ${data.lastChecked}`;

            if (data.updates.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No recent updates found. Your exclusion database is up to date.</p>';
            } else {
                content.innerHTML = '';

                data.updates.forEach(update => {
                    const updateDiv = document.createElement('div');
                    const typeClass = `type-${(update.type || 'analysis').toLowerCase().replace(/_/g, '-')}`;
                    updateDiv.className = `update-item ${typeClass}`;

                    const htsusCodes = update.htsus_codes ?
                        `<div style="margin-top: 8px;"><strong>HTSUS Codes:</strong> ${update.htsus_codes.join(', ')}</div>` : '';

                    const impact = update.impact ?
                        `<div style="margin-top: 8px;"><strong>Impact:</strong> ${update.impact}</div>` : '';

                    const reference = update.reference ?
                        `<div style="margin-top: 8px;">üìÑ <a href="${update.reference}" target="_blank" style="color: #059bd2;">Official Reference</a></div>` : '';

                    updateDiv.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <span class="update-badge badge-${(update.type || 'analysis').toLowerCase()}">${update.type || 'ANALYSIS'}</span>
                            <strong style="font-size: 1.1em;">${update.date || 'Recent'}</strong>
                        </div>
                        <div>${update.description}</div>
                        ${htsusCodes}
                        ${impact}
                        <div style="margin-top: 8px; font-size: 0.9em; color: #666;">Source: ${update.source || 'Unknown'}</div>
                        ${reference}
                    `;

                    content.appendChild(updateDiv);
                });
            }

            modal.style.display = 'block';
            document.getElementById('lastCheckedDisplay').textContent = `Last checked: ${data.lastChecked}`;
        }

        // Close updates modal
        function closeUpdatesModal() {
            document.getElementById('updatesModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('updatesModal');
            if (event.target === modal) {
                closeUpdatesModal();
            }
        }

        // Load last check date on page load
        window.addEventListener('DOMContentLoaded', () => {
            const lastCheck = localStorage.getItem('lastExclusionCheck');
            if (lastCheck) {
                document.getElementById('lastCheckedDisplay').textContent = `Last checked: ${lastCheck}`;
            }
        });
    </script>
</body>
</html>
