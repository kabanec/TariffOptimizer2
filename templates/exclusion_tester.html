<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exclusion Stacking Tester - Tariff Optimizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .exclusion-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        .exclusion-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .exclusion-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .duty-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison-column {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }
        .comparison-column h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        .duty-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #059bd2;
        }
        .duty-item.excluded {
            opacity: 0.5;
            text-decoration: line-through;
            border-left-color: #dc3545;
        }
        .duty-item.reduced {
            border-left-color: #ffc107;
        }
        .total-row {
            font-size: 1.2em;
            font-weight: bold;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-top: 15px;
        }
        .info-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .badge-exempt {
            background: #dc3545;
            color: white;
        }
        .badge-reduced {
            background: #ffc107;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Exclusion Stacking Tester</h1>
            <p>Test Section 99 tariff exclusions and stacking logic</p>
            <div style="text-align: right; margin-top: 10px;">
                <span style="color: white; margin-right: 15px;">Welcome, {{ username }}!</span>
                <a href="{{ url_for('index') }}" style="color: white; text-decoration: underline; margin-right: 15px;">‚Üê Home</a>
                <a href="{{ url_for('logout') }}" style="color: white; text-decoration: underline;">Logout</a>
            </div>
        </header>

        <main>
            <div class="card">
                <h2>Product Information</h2>
                <p style="color: #666; font-size: 0.95em; margin-bottom: 20px;">
                    <strong>Research Sources:</strong> CBP Section 232 FAQs, USTR Section 301 guidance, Federal Register notices, USMCA provisions.
                    Last updated: December 2025. Note: All General Approved Exclusions (GAEs) and country-level arrangements were revoked effective March 12, 2025.
                </p>
                <form id="exclusionForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="hsCode">HS Code *</label>
                            <input type="text" id="hsCode" class="form-control" placeholder="e.g., 3305.10.00.00" required>
                        </div>
                        <div class="form-group">
                            <label for="shipmentValue">Shipment Value (USD) *</label>
                            <input type="number" id="shipmentValue" class="form-control" value="100" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="originCountry">Origin Country *</label>
                            <select id="originCountry" class="form-control" required>
                                <option value="">-- Select Country --</option>
                                <option value="CN" selected>China (CN)</option>
                                <option value="CA">Canada (CA)</option>
                                <option value="MX">Mexico (MX)</option>
                                <option value="DE">Germany (DE)</option>
                                <option value="JP">Japan (JP)</option>
                                <option value="KR">South Korea (KR)</option>
                                <option value="GB">United Kingdom (GB)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="destinationCountry">Destination Country *</label>
                            <select id="destinationCountry" class="form-control" required>
                                <option value="">-- Select Country --</option>
                                <option value="US" selected>United States (US)</option>
                                <option value="CA">Canada (CA)</option>
                                <option value="MX">Mexico (MX)</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-icon">üîç</span>
                            Analyze Exclusions
                        </button>
                    </div>
                </form>
            </div>

            <div id="resultsSection" style="display: none;">
                <div class="card">
                    <h2>Potential Exclusion Codes</h2>
                    <p style="margin-bottom: 20px;">Select applicable exclusions to see how they affect your duties:</p>
                    <div id="exclusionsList"></div>
                </div>

                <div class="card">
                    <h2>Duty Comparison</h2>
                    <div class="duty-comparison">
                        <div class="comparison-column">
                            <h3>Before Exclusions</h3>
                            <div id="dutiesBefore"></div>
                            <div class="total-row">
                                Total Duties: $<span id="totalBefore">0.00</span>
                            </div>
                        </div>
                        <div class="comparison-column">
                            <h3>After Exclusions</h3>
                            <div id="dutiesAfter"></div>
                            <div class="total-row">
                                Total Duties: $<span id="totalAfter">0.00</span>
                                <br>
                                <span style="font-size: 0.85em;">Savings: $<span id="savings">0.00</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Avalara Inc.</p>
        </footer>
    </div>

    <script>
        // Exclusion database - researched from official CBP regulations and Federal Register
        // Sources: CBP.gov Section 232 FAQs, USTR Section 301 guidance, Federal Register notices
        const EXCLUSIONS_DATABASE = {
            // Section 232 Steel - UPDATED WITH RESEARCH
            'section_232_steel': [
                {
                    code: '9903.01.26',
                    name: 'USMCA Exemption: Canada Origin',
                    description: 'Goods that originate in Canada under USMCA qualify for exemption from Section 232 steel duties. Note: All General Approved Exclusions (GAEs) were revoked effective March 12, 2025.',
                    appliesToHsCodes: ['99038187', '99038188', '99038189', '99038190', '99038191', '99038193'],
                    effect: 'EXEMPT',
                    conditions: {
                        originCountries: ['CA'],
                        requiresUSMCA: true
                    },
                    source: 'USMCA general note 11 to HTSUS; CBP CSMS guidance'
                },
                {
                    code: '9903.01.27',
                    name: 'USMCA Exemption: Mexico Origin',
                    description: 'Goods that originate in Mexico under USMCA qualify for exemption from Section 232 steel duties. Note: All General Approved Exclusions (GAEs) were revoked effective March 12, 2025.',
                    appliesToHsCodes: ['99038187', '99038188', '99038189', '99038190', '99038191', '99038193'],
                    effect: 'EXEMPT',
                    conditions: {
                        originCountries: ['MX'],
                        requiresUSMCA: true
                    },
                    source: 'USMCA general note 11 to HTSUS; CBP CSMS guidance'
                },
                {
                    code: '9903.81.92',
                    name: 'U.S.-Origin Steel Exemption',
                    description: 'Derivative steel articles made exclusively from steel melted and poured in the United States (0% tariff-rate). Does NOT apply if steel scrap is remelted and poured outside the U.S.',
                    appliesToHsCodes: ['99038189', '99038190', '99038191', '99038193'],
                    effect: 'EXEMPT',
                    conditions: {
                        usOrigin: true,
                        meltedAndPouredInUS: true
                    },
                    source: 'CBP Section 232 FAQs; Presidential Proclamation'
                },
                {
                    code: 'PRODUCT_EXCLUSION',
                    name: 'Commerce Product-Specific Exclusion',
                    description: 'Time-limited product exclusion granted by U.S. Department of Commerce (valid 1 year or until quantity exhausted). NOTE: Commerce is no longer processing new exclusion requests as of Feb 10, 2025.',
                    appliesToHsCodes: ['99038187', '99038188', '99038189', '99038190', '99038191', '99038193'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresExclusionApproval: true,
                        requiresIORMatch: true,
                        quantityLimited: true
                    },
                    source: 'CBP Active Section 232 Product Exclusions list (updated weekly)'
                }
            ],
            // Section 232 Aluminum - UPDATED WITH RESEARCH
            'section_232_aluminum': [
                {
                    code: '9903.01.26',
                    name: 'USMCA Exemption: Canada Origin',
                    description: 'Goods that originate in Canada under USMCA qualify for exemption from Section 232 aluminum duties. Note: All General Approved Exclusions (GAEs) were revoked effective March 12, 2025.',
                    appliesToHsCodes: ['99038502', '99038504', '99038507', '99038508', '99038509'],
                    effect: 'EXEMPT',
                    conditions: {
                        originCountries: ['CA'],
                        requiresUSMCA: true
                    },
                    source: 'USMCA general note 11 to HTSUS; CBP CSMS guidance'
                },
                {
                    code: '9903.01.27',
                    name: 'USMCA Exemption: Mexico Origin',
                    description: 'Goods that originate in Mexico under USMCA qualify for exemption from Section 232 aluminum duties. Note: All General Approved Exclusions (GAEs) were revoked effective March 12, 2025.',
                    appliesToHsCodes: ['99038502', '99038504', '99038507', '99038508', '99038509'],
                    effect: 'EXEMPT',
                    conditions: {
                        originCountries: ['MX'],
                        requiresUSMCA: true
                    },
                    source: 'USMCA general note 11 to HTSUS; CBP CSMS guidance'
                },
                {
                    code: 'US_ORIGIN_ALUMINUM',
                    name: 'U.S.-Origin Aluminum Exemption',
                    description: 'Derivative aluminum articles made exclusively from aluminum smelted and cast in the United States qualify for exemption from Section 232 duties.',
                    appliesToHsCodes: ['99038504', '99038507', '99038508', '99038509'],
                    effect: 'EXEMPT',
                    conditions: {
                        usOrigin: true,
                        smeltedAndCastInUS: true
                    },
                    source: 'CBP Section 232 FAQs; Presidential Proclamation'
                },
                {
                    code: 'PRODUCT_EXCLUSION',
                    name: 'Commerce Product-Specific Exclusion',
                    description: 'Time-limited product exclusion granted by U.S. Department of Commerce (valid 1 year or until quantity exhausted). NOTE: Commerce is no longer processing new exclusion requests as of Feb 10, 2025.',
                    appliesToHsCodes: ['99038502', '99038504', '99038507', '99038508', '99038509'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresExclusionApproval: true,
                        requiresIORMatch: true,
                        quantityLimited: true
                    },
                    source: 'CBP Active Section 232 Product Exclusions list (updated weekly)'
                }
            ],
            // Section 301 China tariffs - UPDATED WITH RESEARCH
            'section_301': [
                {
                    code: '9903.88.69',
                    name: 'USTR Product-Specific Exclusion (164 products)',
                    description: '164 product-specific exclusions covering certain industrial equipment, EVs, batteries, critical minerals, semiconductors and solar cells. Extended through November 10, 2026.',
                    appliesToHsCodes: ['99038803', '99038804', '99038809', '99038815'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresProductMatch: true,
                        mustMatchDetailedDescription: true
                    },
                    source: 'USTR Federal Register Notice; U.S. note 20(vvv) to subchapter III of chapter 99'
                },
                {
                    code: '9903.88.70',
                    name: 'USTR Manufacturing Equipment Exclusion (14 products)',
                    description: '14 exclusions for manufacturing equipment related to solar manufacturing and other technologies. Extended through November 10, 2026.',
                    appliesToHsCodes: ['99038803', '99038804', '99038809', '99038815'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresProductMatch: true,
                        mustMatchDetailedDescription: true,
                        manufacturingEquipment: true
                    },
                    source: 'USTR Federal Register Notice; U.S. note 20(www) to subchapter III of chapter 99'
                },
                {
                    code: 'SECTION_321',
                    name: 'De Minimis Exemption (Section 321)',
                    description: 'Products properly entered under Section 321 (de minimis shipments) are not subject to Section 301 duties. Note: Goods with quota restrictions require formal entry.',
                    appliesToHsCodes: ['99038803', '99038804', '99038809', '99038815'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresSection321Entry: true,
                        noQuotaRestrictions: true
                    },
                    source: 'CBP Section 301 Trade Remedies FAQs'
                },
                {
                    code: 'CHAPTER_98',
                    name: 'Chapter 98 Provisions',
                    description: 'Duties do not apply to entries properly claimed under Chapter 98 provisions (except 9802.00.40, 9802.00.50, 9802.00.60, 9802.00.80 where duties apply to specific value components).',
                    appliesToHsCodes: ['99038803', '99038804', '99038809', '99038815'],
                    effect: 'EXEMPT',
                    conditions: {
                        requiresChapter98Entry: true,
                        excludesCertainSubheadings: true
                    },
                    source: 'CBP Section 301 Trade Remedies FAQs'
                }
            ],
            // IEEPA Reciprocal Tariffs
            'ieepa_reciprocal': [
                {
                    code: '9903.01.33',
                    name: 'Section 232 Exemption from Reciprocal Tariffs',
                    description: 'Products subject to Section 232 Steel, Aluminum, Autos tariffs are exempt from IEEPA Reciprocal tariffs. The steel/aluminum/copper content line can claim this exception.',
                    appliesToHsCodes: ['99030124', '99030120'],
                    effect: 'EXEMPT',
                    conditions: {
                        subjectToSection232: true
                    },
                    source: 'CBP IEEPA FAQs; CSMS guidance on reciprocal tariffs'
                }
            ]
        };

        // Sample duties for testing (normally would come from API)
        let currentDuties = [];
        let selectedExclusions = new Set();

        document.getElementById('exclusionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            analyzeTariffs();
        });

        function analyzeTariffs() {
            const hsCode = document.getElementById('hsCode').value;
            const value = parseFloat(document.getElementById('shipmentValue').value);
            const origin = document.getElementById('originCountry').value;
            const destination = document.getElementById('destinationCountry').value;

            // Mock duties based on HS code and origin
            // In production, this would come from AvaTax API
            currentDuties = generateMockDuties(hsCode, origin, value);

            displayExclusions(origin);
            displayDutyComparison();
            document.getElementById('resultsSection').style.display = 'block';
        }

        function generateMockDuties(hsCode, origin, value) {
            const duties = [];

            // For HS 3305* from China, add Section 232 and Section 301
            if (hsCode.startsWith('3305') && origin === 'CN') {
                duties.push({
                    code: '99038187',
                    name: 'SECTION 232 STEEL AND STEEL DERIVATIVES',
                    rate: 0.25,
                    amount: value * 0.25,
                    category: 'section_232_steel'
                });
                duties.push({
                    code: '99038502',
                    name: 'SECTION 232 ALUMINUM AND ALUMINUM DERIVATIVES',
                    rate: 0.10,
                    amount: value * 0.10,
                    category: 'section_232_aluminum'
                });
                duties.push({
                    code: '99038803',
                    name: 'SECTION 301 - CHINA',
                    rate: 0.25,
                    amount: value * 0.25,
                    category: 'section_301'
                });
            }

            return duties;
        }

        function displayExclusions(origin) {
            const exclusionsList = document.getElementById('exclusionsList');
            exclusionsList.innerHTML = '';
            selectedExclusions.clear();

            // Find all applicable exclusions
            const applicableExclusions = [];

            for (const category in EXCLUSIONS_DATABASE) {
                EXCLUSIONS_DATABASE[category].forEach(exclusion => {
                    // Check if any current duty matches this exclusion
                    const matchingDuty = currentDuties.find(duty =>
                        exclusion.appliesToHsCodes.includes(duty.code)
                    );

                    if (matchingDuty && checkExclusionConditions(exclusion, origin)) {
                        applicableExclusions.push({
                            ...exclusion,
                            dutyCode: matchingDuty.code,
                            dutyName: matchingDuty.name
                        });
                    }
                });
            }

            if (applicableExclusions.length === 0) {
                exclusionsList.innerHTML = '<p style="color: #666; font-style: italic;">No exclusions available for this product and origin combination.</p>';
                return;
            }

            applicableExclusions.forEach(exclusion => {
                const card = document.createElement('div');
                card.className = 'exclusion-card';
                card.innerHTML = `
                    <label style="cursor: pointer; display: block;">
                        <input type="checkbox" class="exclusion-checkbox" data-code="${exclusion.code}" data-duty="${exclusion.dutyCode}" data-effect="${exclusion.effect}">
                        <strong>${exclusion.name}</strong>
                        <span class="info-badge badge-${exclusion.effect.toLowerCase()}">${exclusion.effect}</span>
                        <br>
                        <small style="color: #666;">Code: ${exclusion.code} | Applies to: ${exclusion.dutyName}</small>
                        <br>
                        <small>${exclusion.description}</small>
                    </label>
                `;
                exclusionsList.appendChild(card);

                card.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedExclusions.add(exclusion.code);
                        card.classList.add('selected');
                    } else {
                        selectedExclusions.delete(exclusion.code);
                        card.classList.remove('selected');
                    }
                    displayDutyComparison();
                });
            });
        }

        function checkExclusionConditions(exclusion, origin) {
            if (exclusion.conditions.originCountries) {
                return exclusion.conditions.originCountries.includes(origin);
            }
            // Add more condition checks as needed
            return true;
        }

        function displayDutyComparison() {
            const dutiesBefore = document.getElementById('dutiesBefore');
            const dutiesAfter = document.getElementById('dutiesAfter');

            dutiesBefore.innerHTML = '';
            dutiesAfter.innerHTML = '';

            let totalBefore = 0;
            let totalAfter = 0;

            currentDuties.forEach(duty => {
                totalBefore += duty.amount;

                // Before exclusions
                const beforeItem = document.createElement('div');
                beforeItem.className = 'duty-item';
                beforeItem.innerHTML = `
                    <strong>${duty.name}</strong><br>
                    Rate: ${(duty.rate * 100).toFixed(2)}%<br>
                    Amount: $${duty.amount.toFixed(2)}
                `;
                dutiesBefore.appendChild(beforeItem);

                // After exclusions
                const afterItem = document.createElement('div');
                afterItem.className = 'duty-item';

                // Check if this duty is excluded
                const isExcluded = isExclusionApplied(duty.code);

                if (isExcluded) {
                    afterItem.classList.add('excluded');
                    afterItem.innerHTML = `
                        <strong>${duty.name}</strong><br>
                        <span style="color: #dc3545;">EXCLUDED</span><br>
                        Original: $${duty.amount.toFixed(2)} ‚Üí $0.00
                    `;
                } else {
                    totalAfter += duty.amount;
                    afterItem.innerHTML = `
                        <strong>${duty.name}</strong><br>
                        Rate: ${(duty.rate * 100).toFixed(2)}%<br>
                        Amount: $${duty.amount.toFixed(2)}
                    `;
                }
                dutiesAfter.appendChild(afterItem);
            });

            document.getElementById('totalBefore').textContent = totalBefore.toFixed(2);
            document.getElementById('totalAfter').textContent = totalAfter.toFixed(2);
            document.getElementById('savings').textContent = (totalBefore - totalAfter).toFixed(2);
        }

        function isExclusionApplied(dutyCode) {
            // Check if any selected exclusion applies to this duty
            for (const category in EXCLUSIONS_DATABASE) {
                for (const exclusion of EXCLUSIONS_DATABASE[category]) {
                    if (selectedExclusions.has(exclusion.code) &&
                        exclusion.appliesToHsCodes.includes(dutyCode)) {
                        return true;
                    }
                }
            }
            return false;
        }
    </script>
</body>
</html>
