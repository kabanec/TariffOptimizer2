<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tariff Lookup - Avalara</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='avalara.css') }}">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #FF6600 0%, #FF8533 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .hero-section h1 {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .hero-section p {
            font-size: 16px;
            font-weight: 400;
            opacity: 0.95;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .compact-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result-hero {
            background: linear-gradient(135deg, #059BD2 0%, #004459 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-hero .main-value {
            font-size: 24px;
            font-weight: 500;
            margin: 5px 0;
        }

        .result-hero .sub-value {
            font-size: 16px;
            font-weight: 400;
            opacity: 0.95;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 6px;
        }

        .info-box .label {
            font-size: 0.75em;
            opacity: 0.8;
            margin-bottom: 3px;
        }

        .info-box .value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .tariff-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .tariff-card:hover {
            border-color: #059BD2;
            box-shadow: 0 4px 12px rgba(5, 155, 210, 0.15);
        }

        .tariff-card.punitive {
            border-color: #FF6600;
            background: #FFF3E6;
        }

        .tariff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .tariff-title {
            font-size: 16px;
            font-weight: 500;
            color: #4A4A4A;
        }

        .tariff-rate {
            font-size: 18px;
            font-weight: 500;
            color: #059BD2;
        }

        .tariff-card.punitive .tariff-rate {
            color: #FF6600;
        }

        .tariff-amount {
            font-size: 20px;
            font-weight: 500;
            color: #4A4A4A;
            margin: 5px 0;
        }

        .tariff-description {
            color: #6B7280;
            font-size: 14px;
            font-weight: 400;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
        }

        .alert-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .alert-success {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .section-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #4A4A4A;
            border-left: 4px solid #FF6600;
            padding-left: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 10;">
                <div>
                    <h1>AvaTax Tariff Calculator</h1>
                    <p class="subtitle">Calculate duties and tariffs for international shipments</p>
                </div>
                <div style="text-align: right; position: relative; z-index: 10;">
                    <span style="color: white; margin-right: 15px;">Welcome, {{ username }}!</span>
                    <a href="{{ url_for('index') }}" style="color: white; text-decoration: underline; margin-right: 15px; cursor: pointer; position: relative; z-index: 10;">‚Üê Home</a>
                    <a href="{{ url_for('logout') }}" style="color: white; text-decoration: underline; cursor: pointer; position: relative; z-index: 10;">Logout</a>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- Hero Calculator Section -->
            <div class="hero-section">
                <h1>Tariff & Duty Calculator</h1>
                <p>Get accurate duty calculations with granular rate breakdown</p>
            </div>

            <!-- Compact Input Form -->
            <div class="compact-form">
                <form id="tariffForm">
                    <div class="input-grid">
                        <div class="form-group">
                            <label for="hsCode">HTS Code *</label>
                            <input type="text" id="hsCode" class="form-control code-input"
                                   placeholder="e.g., 3305.10.00.00"
                                   value="3305.10.00.00" required>
                            <span class="help-text">6-10 digit harmonized code</span>
                        </div>

                        <div class="form-group">
                            <label for="commodityDescription">Commodity Description</label>
                            <input type="text" id="commodityDescription" class="form-control"
                                   placeholder="e.g., Hair preparations"
                                   value="Hair preparations">
                        </div>

                        <div class="form-group">
                            <label for="shipmentValue">Shipment Value (USD) *</label>
                            <input type="number" id="shipmentValue" class="form-control"
                                   placeholder="100" value="100" min="0" step="0.01" required>
                            <span class="help-text">Commercial invoice value</span>
                        </div>

                        <div class="form-group">
                            <label for="originCountry">Country of Origin *</label>
                            <select id="originCountry" class="form-control" required>
                                <option value="CN" selected>China (CN)</option>
                                <option value="MX">Mexico (MX)</option>
                                <option value="CA">Canada (CA)</option>
                                <option value="VN">Vietnam (VN)</option>
                                <option value="IN">India (IN)</option>
                                <option value="JP">Japan (JP)</option>
                                <option value="KR">South Korea (KR)</option>
                                <option value="TW">Taiwan (TW)</option>
                                <option value="DE">Germany (DE)</option>
                                <option value="GB">United Kingdom (GB)</option>
                                <option value="IT">Italy (IT)</option>
                                <option value="FR">France (FR)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="entryDate">Entry Date *</label>
                            <input type="date" id="entryDate" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="calculatorType">Calculator Type *</label>
                            <select id="calculatorType" class="form-control" required>
                                <option value="courier" selected>Courier (Standard)</option>
                                <option value="postal">Postal</option>
                            </select>
                            <span class="help-text">Courier omits shipmentType, Postal includes it</span>
                        </div>
                    </div>

                    <!-- Advanced Options (Initially Hidden - Driven by API Response) -->
                    <div id="advancedOptions" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
                        <h3 style="margin-bottom: 15px;">Additional Options</h3>
                        <div class="input-grid">
                            <div class="form-group">
                                <label for="destinationCountry">Destination Country</label>
                                <select id="destinationCountry" class="form-control">
                                    <option value="US" selected>United States (US)</option>
                                    <option value="CA">Canada (CA)</option>
                                    <option value="MX">Mexico (MX)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-icon">üîç</span>
                            Calculate Duties
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <span class="btn-icon">üîÑ</span>
                            Reset
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Calculating tariffs and duties...</p>
            </div>

            <!-- Error Display -->
            <div id="errorDisplay" style="display: none;"></div>

            <!-- Section 232 Automotive Parameter Selection -->
            <div id="section232AutomotivePanel" class="section" style="display: none;">
                <h2 class="section-title">Section 232 - Automotive Parameters Required</h2>
                <div class="alert-warning">
                    <strong>‚ö†Ô∏è Section 232 Automotive Duties Detected</strong><br>
                    Please specify the automotive category to calculate accurate duties.
                </div>
                <div class="compact-form">
                    <div class="form-group">
                        <label for="section232Auto">Automotive Category *</label>
                        <select id="section232Auto" class="form-control" required>
                            <option value="">-- Select Category --</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <span class="help-text">Select the automotive category that applies to your shipment</span>
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="recalculateWithSection232Automotive()">
                            <span class="btn-icon">üîç</span>
                            Recalculate with Parameters
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="cancelSection232()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section 232 Metals Parameter Selection -->
            <div id="section232MetalsPanel" class="section" style="display: none;">
                <h2 class="section-title">Section 232 - Metal Composition Parameters Required</h2>
                <div class="alert-warning">
                    <strong>‚ö†Ô∏è Section 232 Metal Duties Detected</strong><br>
                    Please specify the metal composition and country of origin for each detected metal.
                </div>
                <div class="compact-form">
                    <div id="metalCompositionFields">
                        <!-- Metal fields will be dynamically populated by JavaScript -->
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="recalculateWithSection232Metals()">
                            <span class="btn-icon">üîç</span>
                            Recalculate with Parameters
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="cancelSection232()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <!-- Punitive Tariffs Warning (if applicable) -->
                <div id="punitiveWarning" style="display: none;">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Standard Duty Breakdown -->
                <div class="section">
                    <h2 class="section-title">Standard Duty Breakdown</h2>
                    <div id="standardDuties">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Punitive Tariffs Section -->
                <div class="section" id="punitiveTariffsSection" style="display: none;">
                    <h2 class="section-title">Punitive Tariffs (Chapter 98/99)</h2>
                    <div id="punitiveTariffs">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- AI Analysis (Collapsible) -->
                <div class="section">
                    <h2>
                        <button class="btn btn-secondary" onclick="toggleAIAnalysis()" style="font-size: 0.9em; padding: 8px 15px;">
                            <span id="aiToggleIcon">‚ñ∂</span> AI-Powered Insights
                        </button>
                    </h2>
                    <div class="result-card" id="aiAnalysisCard" style="display: none;">
                        <div class="ai-analysis" id="aiAnalysis">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Raw API Response (Collapsible) -->
                <div class="section">
                    <h2>
                        <button class="btn btn-secondary" onclick="toggleRawResponse()" style="font-size: 0.9em; padding: 8px 15px;">
                            <span id="toggleIcon">‚ñ∂</span> View Raw API Response
                        </button>
                    </h2>
                    <div class="result-card" id="rawResponseCard" style="display: none;">
                        <div class="response-header">
                            <h3>AvaTax API Response</h3>
                            <button class="btn-copy" onclick="copyToClipboard('rawResponse')">üìã Copy</button>
                        </div>
                        <pre class="code-output" id="rawResponse"></pre>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 Avalara Tariff Optimizer. Powered by AvaTax API and OpenAI.</p>
        </footer>
    </div>

    <script>
        // Set today's date as default
        document.getElementById('entryDate').valueAsDate = new Date();

        document.getElementById('tariffForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await calculateTariffs();
        });

        async function calculateTariffs() {
            const hsCode = document.getElementById('hsCode').value.trim();
            const originCountry = document.getElementById('originCountry').value;
            const destinationCountry = document.getElementById('destinationCountry').value;
            const entryDate = document.getElementById('entryDate').value;
            const shipmentValue = parseFloat(document.getElementById('shipmentValue').value);
            const commodityDescription = document.getElementById('commodityDescription').value;
            const calculatorType = document.getElementById('calculatorType').value;

            console.log('=== TARIFF CALCULATION STARTED ===');
            console.log('HTS Code:', hsCode);
            console.log('Origin:', originCountry);
            console.log('Destination:', destinationCountry);
            console.log('Value:', shipmentValue);

            // Show loading and hide all panels
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorDisplay').style.display = 'none';
            document.getElementById('section232AutomotivePanel').style.display = 'none';
            document.getElementById('section232MetalsPanel').style.display = 'none';

            try {
                const requestPayload = {
                    hsCode,
                    originCountry,
                    destinationCountry,
                    entryDate,
                    shipmentValue,
                    modeOfTransport: 'AIR', // Default to AIR
                    calculatorType,
                    environment: 'sandbox'
                };

                console.log('Request payload:', requestPayload);

                const response = await fetch('/api/tariff-lookup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestPayload)
                });

                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to calculate tariffs');
                }

                // Store metal options globally for later use if automotive is not applicable
                window.currentMetalOptions = data.section232MetalOptions || [];
                window.currentShipmentValue = shipmentValue;

                // DEBUG: Log what we received
                console.log('Section 232 Automotive Options:', data.section232AutomotiveOptions);
                console.log('Section 232 Metal Options:', data.section232MetalOptions);

                // Check if Section 232 parameters are required
                // IMPORTANT: Section 232 only applies to courier/air/ocean, NOT postal
                const isPostal = calculatorType === 'postal';

                if (!isPostal && data.section232AutomotiveOptions && data.section232AutomotiveOptions.length > 0) {
                    const hasMetals = data.section232MetalOptions && data.section232MetalOptions.length > 0;
                    console.log('Showing automotive panel, hasMetals:', hasMetals);
                    showSection232AutomotivePanel(data.section232AutomotiveOptions, hasMetals);
                } else if (!isPostal && data.section232MetalOptions && data.section232MetalOptions.length > 0) {
                    console.log('Showing metals panel with options:', data.section232MetalOptions);
                    showSection232MetalsPanel(data.section232MetalOptions);
                } else {
                    console.log('No Section 232 parameters required (or postal calculator), showing results');
                    displayResults(data, shipmentValue);
                }
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function showSection232AutomotivePanel(options, hasMetals) {
            // Hide results, show Section 232 automotive parameter panel
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('section232MetalsPanel').style.display = 'none';
            document.getElementById('section232AutomotivePanel').style.display = 'block';

            // Populate dropdown with options
            const select = document.getElementById('section232Auto');
            select.innerHTML = '<option value="">-- Select Category --</option>';

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.keyword;
                option.textContent = opt.keyword + ' - ' + opt.description;
                select.appendChild(option);
            });

            // If there are also metal duties, add "Not related to automotive" option
            if (hasMetals) {
                const notRelatedOption = document.createElement('option');
                notRelatedOption.value = '__NOT_AUTOMOTIVE__';
                notRelatedOption.textContent = 'Not related to automotive (proceed to metal composition)';
                select.appendChild(notRelatedOption);
            }
        }

        function showSection232MetalsPanel(metalOptions) {
            console.log('showSection232MetalsPanel called with:', JSON.stringify(metalOptions, null, 2));

            // Hide other panels, show metals panel
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('section232AutomotivePanel').style.display = 'none';
            document.getElementById('section232MetalsPanel').style.display = 'block';

            // Populate metal composition fields
            const fieldsContainer = document.getElementById('metalCompositionFields');
            fieldsContainer.innerHTML = '';

            // Get product origin country from form
            const productOriginCountry = document.getElementById('originCountry').value || '';

            // Create grid container for 2-column layout
            const gridContainer = document.createElement('div');
            gridContainer.style.display = 'grid';
            gridContainer.style.gridTemplateColumns = metalOptions.length > 1 ? 'repeat(2, 1fr)' : '1fr';
            gridContainer.style.gap = '15px';
            gridContainer.style.marginBottom = '10px';

            console.log(`Creating fields for ${metalOptions.length} metals`);
            metalOptions.forEach((metalOpt, index) => {
                console.log(`Processing metal ${index}:`, metalOpt);
                const metalType = metalOpt.metal;
                const metalCapitalized = metalType.charAt(0).toUpperCase() + metalType.slice(1);

                const fieldGroup = document.createElement('div');
                fieldGroup.style.padding = '12px';
                fieldGroup.style.background = '#f8f9fa';
                fieldGroup.style.borderRadius = '6px';
                fieldGroup.style.border = '1px solid #dee2e6';

                fieldGroup.innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: #4A4A4A; font-size: 16px; font-weight: 500;">
                        <span style="color: #059BD2;">‚óè</span> ${metalCapitalized}
                    </h4>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: start;">
                        <div>
                            <label for="metal_percent_${metalType}" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; color: #4A4A4A;">
                                Percentage
                            </label>
                            <input type="range" id="metal_percent_slider_${metalType}"
                                   min="0" max="100" value="0" step="0.1"
                                   style="width: 100%; height: 6px; border-radius: 3px; background: #ddd; outline: none; cursor: pointer;"
                                   oninput="updateMetalSliderValue('${metalType}', this.value)"
                                   data-metal="${metalType}">
                            <div style="text-align: center; margin-top: 5px; font-size: 20px; font-weight: 500; color: #FF6600;">
                                <span id="metal_percent_value_${metalType}">0</span>%
                            </div>
                            <input type="hidden" id="metal_percent_${metalType}" value="0" data-metal="${metalType}">
                        </div>

                        <div>
                            <label for="metal_coo_${metalType}" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; color: #4A4A4A;">
                                Origin Country
                            </label>
                            <select id="metal_coo_${metalType}" class="form-control" required data-metal="${metalType}"
                                    style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                                <option value="">-- Select --</option>
                                <option value="US" ${productOriginCountry === 'US' ? 'selected' : ''}>US</option>
                                <option value="CN" ${productOriginCountry === 'CN' ? 'selected' : ''}>China</option>
                                <option value="CA" ${productOriginCountry === 'CA' ? 'selected' : ''}>Canada</option>
                                <option value="MX" ${productOriginCountry === 'MX' ? 'selected' : ''}>Mexico</option>
                                <option value="JP" ${productOriginCountry === 'JP' ? 'selected' : ''}>Japan</option>
                                <option value="KR" ${productOriginCountry === 'KR' ? 'selected' : ''}>S. Korea</option>
                                <option value="DE" ${productOriginCountry === 'DE' ? 'selected' : ''}>Germany</option>
                                <option value="FR" ${productOriginCountry === 'FR' ? 'selected' : ''}>France</option>
                                <option value="GB" ${productOriginCountry === 'GB' ? 'selected' : ''}>UK</option>
                                <option value="IT" ${productOriginCountry === 'IT' ? 'selected' : ''}>Italy</option>
                                <option value="ES" ${productOriginCountry === 'ES' ? 'selected' : ''}>Spain</option>
                                <option value="IN" ${productOriginCountry === 'IN' ? 'selected' : ''}>India</option>
                                <option value="BR" ${productOriginCountry === 'BR' ? 'selected' : ''}>Brazil</option>
                                <option value="VN" ${productOriginCountry === 'VN' ? 'selected' : ''}>Vietnam</option>
                                <option value="TH" ${productOriginCountry === 'TH' ? 'selected' : ''}>Thailand</option>
                                <option value="MY" ${productOriginCountry === 'MY' ? 'selected' : ''}>Malaysia</option>
                                <option value="ID" ${productOriginCountry === 'ID' ? 'selected' : ''}>Indonesia</option>
                                <option value="PH" ${productOriginCountry === 'PH' ? 'selected' : ''}>Philippines</option>
                                <option value="PL" ${productOriginCountry === 'PL' ? 'selected' : ''}>Poland</option>
                                <option value="TR" ${productOriginCountry === 'TR' ? 'selected' : ''}>Turkey</option>
                            </select>
                            <span class="help-text" style="display: block; margin-top: 3px; color: #6B7280; font-size: 12px; font-weight: 400;">
                                ${productOriginCountry ? 'Default: product COO' : ''}
                            </span>
                        </div>
                    </div>
                `;

                gridContainer.appendChild(fieldGroup);
            });

            fieldsContainer.appendChild(gridContainer);
        }

        function updateMetalSliderValue(metalType, value) {
            // Update the displayed value
            const valueSpan = document.getElementById(`metal_percent_value_${metalType}`);
            if (valueSpan) {
                valueSpan.textContent = parseFloat(value).toFixed(1);
            }

            // Update the hidden input value
            const hiddenInput = document.getElementById(`metal_percent_${metalType}`);
            if (hiddenInput) {
                hiddenInput.value = value;
            }
        }

        async function recalculateWithSection232Automotive() {
            const section232Auto = document.getElementById('section232Auto').value;
            if (!section232Auto) {
                alert('Please select an automotive category');
                return;
            }

            // Check if user selected "Not related to automotive"
            if (section232Auto === '__NOT_AUTOMOTIVE__') {
                // Show metals panel instead
                if (window.currentMetalOptions && window.currentMetalOptions.length > 0) {
                    showSection232MetalsPanel(window.currentMetalOptions);
                }
                return;
            }

            // Hide section 232 panel, show loading
            document.getElementById('section232AutomotivePanel').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'block';

            const hsCode = document.getElementById('hsCode').value.trim();
            const originCountry = document.getElementById('originCountry').value;
            const destinationCountry = document.getElementById('destinationCountry').value;
            const entryDate = document.getElementById('entryDate').value;
            const shipmentValue = parseFloat(document.getElementById('shipmentValue').value);
            const calculatorType = document.getElementById('calculatorType').value;

            try {
                const response = await fetch('/api/tariff-lookup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hsCode,
                        originCountry,
                        destinationCountry,
                        entryDate,
                        shipmentValue,
                        modeOfTransport: 'AIR',
                        calculatorType,
                        section232Auto: section232Auto,
                        environment: 'sandbox'
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to calculate tariffs');
                }

                displayResults(data, shipmentValue);
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function recalculateWithSection232Metals() {
            // Collect metal composition data
            const metalComposition = [];
            const metalInputs = document.querySelectorAll('#metalCompositionFields input[data-metal]');
            let totalPercentage = 0;

            for (const input of metalInputs) {
                const metalType = input.dataset.metal;
                const percentageValue = parseFloat(input.value);
                const countrySelect = document.getElementById(`metal_coo_${metalType}`);
                const country = countrySelect.value;

                if (!country) {
                    alert(`Please select country of origin for ${metalType}`);
                    return;
                }

                if (isNaN(percentageValue) || percentageValue < 0 || percentageValue > 100) {
                    alert(`Please enter a valid percentage (0-100) for ${metalType}`);
                    return;
                }

                totalPercentage += percentageValue;

                // Convert percentage to decimal (e.g., 100% = 1.0, 20% = 0.20)
                const decimalValue = (percentageValue / 100).toFixed(2);

                metalComposition.push({
                    metal: metalType,
                    percentage: decimalValue,
                    country: country
                });
            }

            // Validate total percentage doesn't exceed 100%
            if (totalPercentage > 100) {
                alert(`Total metal composition cannot exceed 100%. Current total: ${totalPercentage.toFixed(2)}%`);
                return;
            }

            // Show loading (keep metals panel visible)
            document.getElementById('loadingIndicator').style.display = 'block';

            const hsCode = document.getElementById('hsCode').value.trim();
            const originCountry = document.getElementById('originCountry').value;
            const destinationCountry = document.getElementById('destinationCountry').value;
            const entryDate = document.getElementById('entryDate').value;
            const shipmentValue = parseFloat(document.getElementById('shipmentValue').value);
            const calculatorType = document.getElementById('calculatorType').value;

            try {
                const response = await fetch('/api/tariff-lookup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hsCode,
                        originCountry,
                        destinationCountry,
                        entryDate,
                        shipmentValue,
                        modeOfTransport: 'AIR',
                        calculatorType,
                        metalComposition: metalComposition,
                        environment: 'sandbox'
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to calculate tariffs');
                }

                displayResults(data, shipmentValue);

                // Keep Section 232 metals panel visible so user can adjust and recalculate
                document.getElementById('section232MetalsPanel').style.display = 'block';
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function cancelSection232() {
            document.getElementById('section232AutomotivePanel').style.display = 'none';
            document.getElementById('section232MetalsPanel').style.display = 'none';
        }

        function displayResults(data, shipmentValue) {
            const { apiResponse, aiAnalysis, dutyBreakdown, punitiveTariffs } = data;

            // Display Punitive Warning
            const punitiveWarning = document.getElementById('punitiveWarning');
            if (punitiveTariffs && punitiveTariffs.length > 0) {
                punitiveWarning.style.display = 'block';
                punitiveWarning.innerHTML = `
                    <div class="alert-warning">
                        <strong>‚ö†Ô∏è Punitive Tariffs Apply</strong><br>
                        This shipment is subject to ${punitiveTariffs.length} additional punitive tariff(s) (Chapter 98/99).
                        See details below.
                    </div>
                `;
            } else {
                punitiveWarning.style.display = 'none';
            }

            // Display Standard Duties
            const standardDutiesDiv = document.getElementById('standardDuties');
            if (dutyBreakdown && dutyBreakdown.length > 0) {
                let dutiesHTML = '';
                dutyBreakdown.forEach(duty => {
                    const ratePercent = duty.rate ? (duty.rate * 100).toFixed(2) : '0.00';
                    const amount = duty.tax ? duty.tax.toFixed(2) : '0.00';
                    dutiesHTML += `
                        <div class="tariff-card">
                            <div class="tariff-header">
                                <div class="tariff-title">${duty.taxName || 'Standard Duty'}</div>
                                <div class="tariff-rate">${ratePercent}%</div>
                            </div>
                            <div class="tariff-amount">$${amount}</div>
                            ${duty.description ? `<div class="tariff-description">${duty.description}</div>` : ''}
                            ${duty.hsCode ? `<div class="tariff-description"><strong>HS Code:</strong> ${duty.hsCode}</div>` : ''}
                        </div>
                    `;
                });
                standardDutiesDiv.innerHTML = dutiesHTML;
            } else {
                standardDutiesDiv.innerHTML = '<div class="alert-success">No standard duties apply to this shipment.</div>';
            }

            // Display Punitive Tariffs
            const punitiveTariffsSection = document.getElementById('punitiveTariffsSection');
            const punitiveTariffsDiv = document.getElementById('punitiveTariffs');

            if (punitiveTariffs && punitiveTariffs.length > 0) {
                punitiveTariffsSection.style.display = 'block';
                let punitiveHTML = '';
                punitiveTariffs.forEach(tariff => {
                    const ratePercent = tariff.rate ? (tariff.rate * 100).toFixed(2) : '0.00';
                    const amount = tariff.tax ? tariff.tax.toFixed(2) : '0.00';
                    punitiveHTML += `
                        <div class="tariff-card punitive">
                            <div class="tariff-header">
                                <div class="tariff-title">${tariff.taxName || 'Punitive Tariff'}</div>
                                <div class="tariff-rate">${ratePercent}%</div>
                            </div>
                            <div class="tariff-amount">$${amount}</div>
                            ${tariff.explanation ? `<div class="tariff-description"><strong>Reason:</strong> ${tariff.explanation}</div>` : ''}
                            ${tariff.hsCode ? `<div class="tariff-description"><strong>Chapter 98/99 Code:</strong> ${tariff.hsCode}</div>` : ''}
                        </div>
                    `;
                });
                punitiveTariffsDiv.innerHTML = punitiveHTML;
            } else {
                punitiveTariffsSection.style.display = 'none';
            }

            // Display AI Analysis
            const aiAnalysisDiv = document.getElementById('aiAnalysis');
            if (aiAnalysis) {
                aiAnalysisDiv.innerHTML = formatMarkdown(aiAnalysis);
            } else {
                aiAnalysisDiv.innerHTML = '<p style="color: #666; font-style: italic;">AI analysis is only available after completing Section 232 parameter selection.</p>';
            }

            // Display Raw Response
            document.getElementById('rawResponse').textContent = JSON.stringify(apiResponse, null, 2);

            // Show results
            document.getElementById('resultsSection').style.display = 'block';

            // Show advanced options for refinement
            document.getElementById('advancedOptions').style.display = 'block';
        }

        function formatMarkdown(text) {
            // Simple markdown formatting
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^(.+)$/, '<p>$1</p>');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.innerHTML = `<div class="alert alert-error" style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 15px; margin-bottom: 20px;">‚ùå <strong>Error:</strong> ${message}</div>`;
            errorDiv.style.display = 'block';
        }

        function clearForm() {
            document.getElementById('tariffForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorDisplay').style.display = 'none';
            document.getElementById('advancedOptions').style.display = 'none';
        }

        function toggleAIAnalysis() {
            const card = document.getElementById('aiAnalysisCard');
            const icon = document.getElementById('aiToggleIcon');
            if (card.style.display === 'none') {
                card.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                card.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function toggleRawResponse() {
            const card = document.getElementById('rawResponseCard');
            const icon = document.getElementById('toggleIcon');
            if (card.style.display === 'none') {
                card.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                card.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        }
    </script>
</body>
</html>
